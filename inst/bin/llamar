#!/usr/bin/env r
#
# llamar - An open-source interactive CLI agent in R
#
# Usage: llamar [options]
#   --provider   anthropic|openai|ollama (default: anthropic)
#   --model      model name (default: provider-specific)
#   --port       MCP server port (default: 7850)
#

# Load .Renviron explicitly (littler may not load it automatically)
renviron <- path.expand("~/.Renviron")
if (file.exists(renviron)) readRenviron(renviron)

suppressPackageStartupMessages({
  library(jsonlite)
  library(llm.api)
  library(llamaR)
})

# ============================================================================
# CLI argument parsing
# ============================================================================

parse_args <- function() {
  args <- commandArgs(trailingOnly = TRUE)

  opts <- list(
    provider = "anthropic",
    model = NULL,
    port = 7850L
  )

  i <- 1
  while (i <= length(args)) {
    arg <- args[i]
    if (arg == "--provider" && i < length(args)) {
      opts$provider <- args[i + 1]
      i <- i + 2
    } else if (arg == "--model" && i < length(args)) {
      opts$model <- args[i + 1]
      i <- i + 2
    } else if (arg == "--port" && i < length(args)) {
      opts$port <- as.integer(args[i + 1])
      i <- i + 2
    } else if (arg == "--help" || arg == "-h") {
      cat("
llamar - An open-source interactive CLI agent

Usage: llamar [options]

Options:
  --provider   LLM provider: anthropic, openai, ollama (default: anthropic)
  --model      Model name (default: auto per provider)
  --port       MCP server port (default: 7850)
  --help       Show this help

Commands (in chat):
  /quit, /exit   Exit llamar
  /tools         List available tools
  /clear         Clear conversation history
  /model <name>  Switch model
  /provider <p>  Switch provider

")
      quit(save = "no", status = 0)
    } else {
      i <- i + 1
    }
  }

  opts
}

# ============================================================================
# Server management
# ============================================================================

start_server <- function(port) {
  # Check if already running
  conn <- tryCatch(
    socketConnection("localhost", port, open = "r+b", blocking = TRUE, timeout = 1),
    error = function(e) NULL
  )

  if (!is.null(conn)) {
    close(conn)
    return(TRUE)  # Already running
  }

  # Start server using llamaR::serve()
  cwd <- getwd()
  cmd <- sprintf('llamaR::serve(port = %d, cwd = "%s")', port, cwd)

  if (.Platform$OS.type == "windows") {
    system2("Rscript", c("-e", shQuote(cmd)), wait = FALSE, stdout = FALSE, stderr = FALSE)
  } else {
    system2("Rscript", c("-e", shQuote(cmd)), wait = FALSE,
            stdout = "/dev/null", stderr = "/dev/null")
  }

  # Wait for startup
  for (i in 1:20) {
    Sys.sleep(0.25)
    conn <- tryCatch(
      socketConnection("localhost", port, open = "r+b", blocking = TRUE, timeout = 1),
      error = function(e) NULL
    )
    if (!is.null(conn)) {
      close(conn)
      return(TRUE)
    }
  }

  FALSE
}

# ============================================================================
# Display helpers
# ============================================================================

color <- list(
  reset = "\033[0m",
  bold = "\033[1m",
  dim = "\033[2m",
  green = "\033[32m",
  blue = "\033[34m",
  cyan = "\033[36m",
  yellow = "\033[33m",
  magenta = "\033[35m"
)

print_banner <- function() {
  cat(sprintf("\n%s llamar%s\n", color$cyan, color$reset))
  cat(sprintf("%sType /help for commands, /quit to exit%s\n\n", color$dim, color$reset))
}

print_tool <- function(name, args) {
  cat(sprintf("\n%s[%s]%s", color$yellow, name, color$reset))
  if (length(args) > 0) {
    args_str <- paste(names(args), sapply(args, function(x) {
      if (is.character(x) && nchar(x) > 50) paste0(substr(x, 1, 47), "...")
      else as.character(x)
    }), sep = "=", collapse = ", ")
    cat(sprintf(" %s%s%s", color$dim, args_str, color$reset))
  }
  cat("\n")
}

print_result <- function(text, max_lines = 20) {
  lines <- strsplit(text, "\n")[[1]]
  if (length(lines) > max_lines) {
    cat(paste(lines[1:max_lines], collapse = "\n"))
    cat(sprintf("\n%s... (%d more lines)%s\n", color$dim, length(lines) - max_lines, color$reset))
  } else {
    cat(text, "\n")
  }
}

print_response <- function(text) {
  cat(sprintf("\n%s%s%s\n", color$reset, text, color$reset))
}

# ============================================================================
# Main agent loop
# ============================================================================

run_agent <- function(opts) {
  print_banner()

  # Start/connect to MCP server
  cat(sprintf("%sStarting MCP server on port %d...%s\n", color$dim, opts$port, color$reset))

  if (!start_server(opts$port)) {
    cat(sprintf("%sError: Could not start MCP server%s\n", color$yellow, color$reset))
    cat("Make sure llamaR package is installed.\n")
    return(invisible(NULL))
  }

  # Connect
  conn <- tryCatch(
    mcp_connect(port = opts$port, name = "llamar"),
    error = function(e) {
      cat(sprintf("%sError connecting to server: %s%s\n", color$yellow, e$message, color$reset))
      NULL
    }
  )

  if (is.null(conn)) return(invisible(NULL))

  cat(sprintf("%sConnected. %d tools available.%s\n\n",
              color$dim, length(conn$tools), color$reset))

  # Get tools for LLM
  tools <- mcp_tools_for_api(conn)

  # Tool handler
  tool_handler <- function(name, args) {
    print_tool(name, args)
    result <- tryCatch({
      mcp_call(conn, name, args)
    }, error = function(e) {
      cat(sprintf("%sTool error: %s%s\n", color$yellow, e$message, color$reset))
      list(text = paste("Error:", e$message))
    })
    text <- result$text %||% ""
    if (nchar(text) > 0) {
      print_result(text)
    }
    text
  }

  # Conversation state
  history <- list()
  provider <- opts$provider
  model <- opts$model

  # Display model
  display_model <- model %||% switch(provider,
    anthropic = "claude-sonnet-4-20250514",
    openai = "gpt-4o",
    ollama = "llama3.2"
  )

  cat(sprintf("%s%s @ %s%s\n", color$dim, display_model, provider, color$reset))

  # REPL
  while (TRUE) {
    # Prompt and read input via bash (avoids R's stdin echo)
    prompt <- system(
      sprintf('read -p "%s>%s " line && echo "$line"', color$green, color$reset),
      intern = TRUE
    )

    # Handle EOF (Ctrl+D)
    if (length(prompt) == 0) {
      cat("\n")
      break
    }

    prompt <- trimws(prompt)
    if (nchar(prompt) == 0) next

    # Handle commands
    if (startsWith(prompt, "/")) {
      cmd_parts <- strsplit(prompt, "\\s+")[[1]]
      cmd <- tolower(cmd_parts[1])
      cmd_arg <- if (length(cmd_parts) > 1) cmd_parts[2] else NULL

      if (cmd %in% c("/quit", "/exit", "/q")) {
        break
      } else if (cmd == "/tools") {
        cat(sprintf("\n%sAvailable tools:%s\n", color$bold, color$reset))
        for (tool in conn$tools) {
          cat(sprintf("  %s%s%s - %s\n", color$cyan, tool$name, color$reset,
                      tool$description %||% ""))
        }
        cat("\n")
        next
      } else if (cmd == "/clear") {
        history <- list()
        cat(sprintf("%sConversation cleared.%s\n", color$dim, color$reset))
        next
      } else if (cmd == "/model" && !is.null(cmd_arg)) {
        model <- cmd_arg
        cat(sprintf("%sModel set to: %s%s\n", color$dim, model, color$reset))
        next
      } else if (cmd == "/provider" && !is.null(cmd_arg)) {
        provider <- cmd_arg
        cat(sprintf("%sProvider set to: %s%s\n", color$dim, provider, color$reset))
        next
      } else if (cmd == "/help") {
        cat("
Commands:
  /quit, /exit   Exit llamar
  /tools         List available tools
  /clear         Clear conversation history
  /model <name>  Switch model
  /provider <p>  Switch provider (anthropic, openai, ollama)
  /help          Show this help

")
        next
      } else {
        cat(sprintf("%sUnknown command: %s%s\n", color$yellow, cmd, color$reset))
        next
      }
    }

    # Send to LLM with tools
    # Debug: check config before call
    .config <- llm.api:::.get_provider_config(provider)
    if (nchar(.config$api_key) == 0) {
      cat(sprintf("%sWarning: No API key found for %s%s\n", color$yellow, provider, color$reset))
      cat("Set ANTHROPIC_API_KEY in ~/.Renviron\n")
      next
    }

    result <- tryCatch({
      agent(
        prompt = prompt,
        tools = tools,
        tool_handler = tool_handler,
        model = model,
        provider = provider,
        verbose = FALSE  # We handle display ourselves
      )
    }, error = function(e) {
      cat(sprintf("%sError: %s%s\n", color$yellow, e$message, color$reset))
      NULL
    })

    if (!is.null(result)) {
      print_response(result$content)
    }
  }

  # Cleanup
  cat(sprintf("\n%sGoodbye.%s\n", color$dim, color$reset))
  suppressWarnings(mcp_close(conn))
}

# ============================================================================
# Entry point
# ============================================================================

if (!interactive()) {
  opts <- parse_args()
  run_agent(opts)
}
