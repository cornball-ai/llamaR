#!/usr/bin/env Rscript
#
# llamar - An open-source interactive CLI agent in R
#
# Usage: llamar [options]
#   --provider   anthropic|openai|ollama (default: anthropic)
#   --model      model name (default: provider-specific)
#   --port       MCP server port (default: 7850)
#   --resume   Resume the latest session for this directory
#   --session    Resume a specific session by ID
#   --list       List sessions for this directory
#

# Load .Renviron explicitly (littler may not load it automatically)
renviron <- path.expand("~/.Renviron")
if (file.exists(renviron)) readRenviron(renviron)

suppressPackageStartupMessages({
  library(jsonlite)
  library(llm.api)
  library(llamaR)
})

# ============================================================================
# CLI argument parsing
# ============================================================================

parse_args <- function() {
  args <- commandArgs(trailingOnly = TRUE)

  # Load config for defaults
  config <- llamaR:::load_config(getwd())

  opts <- list(
    provider = config$provider %||% "anthropic",
    model = config$model,
    port = config$port %||% 7850L,
    tools = config$tools,  # NULL = all tools
    context_warn_pct = config$context_warn_pct %||% 75L,
    context_crit_pct = config$context_crit_pct %||% 90L,
    resume = FALSE,
    session = NULL,
    list = FALSE
  )

  i <- 1
  while (i <= length(args)) {
    arg <- args[i]
    if (arg == "--provider" && i < length(args)) {
      opts$provider <- args[i + 1]
      i <- i + 2
    } else if (arg == "--model" && i < length(args)) {
      opts$model <- args[i + 1]
      i <- i + 2
    } else if (arg == "--port" && i < length(args)) {
      opts$port <- as.integer(args[i + 1])
      i <- i + 2
    } else if (arg == "--resume" || arg == "-r") {
      opts$resume <- TRUE
      i <- i + 1
    } else if (arg == "--session" && i < length(args)) {
      opts$session <- args[i + 1]
      i <- i + 2
    } else if (arg == "--list") {
      opts$list <- TRUE
      i <- i + 1
    } else if (arg == "--tools" && i < length(args)) {
      opts$tools <- strsplit(args[i + 1], ",")[[1]]
      i <- i + 2
    } else if (arg == "--help" || arg == "-h") {
      cat("
llamar - An open-source interactive CLI agent

Usage: llamar [options]

Options:
  --provider   LLM provider: anthropic, openai, ollama (default: anthropic)
  --model      Model name (default: auto per provider)
  --port       MCP server port (default: 7850)
  --tools      Tool filter: core, file, code, git, r, data, web, chat (default: all)
               Example: --tools core or --tools file,git,code
  --resume     Resume the latest session for this directory
  --session ID Resume a specific session
  --list       List sessions for this directory
  --help       Show this help

Commands (in chat):
  /quit, /exit   Exit llamar
  /tools         List available tools
  /clear         Clear conversation (keeps session)
  /sessions      List sessions for this directory
  /context       Show loaded context files
  /model <name>  Switch model
  /provider <p>  Switch provider

Context files (auto-loaded if present):
  README.md      Project description
  PLAN.md        Development roadmap
  fyi.md         Package introspection (from fyi package)
  AGENTS.md      Agent behavior guidelines

Config files:
  ~/.llamar/config.json        Global defaults
  .llamar/config.json          Project overrides

")
      quit(save = "no", status = 0)
    } else {
      i <- i + 1
    }
  }

  opts
}

# ============================================================================
# Server management
# ============================================================================

start_server <- function(port, tools = NULL) {
  # Check if already running
  conn <- tryCatch(
    socketConnection("localhost", port, open = "r+b", blocking = TRUE, timeout = 1),
    error = function(e) NULL
  )

  if (!is.null(conn)) {
    close(conn)
    return(TRUE)  # Already running
  }

  # Start server using llamaR::serve()
  cwd <- getwd()
  tools_arg <- if (!is.null(tools)) {
    sprintf(', tools = c(%s)', paste0('"', tools, '"', collapse = ", "))
  } else ""
  cmd <- sprintf('llamaR::serve(port = %d, cwd = "%s"%s)', port, cwd, tools_arg)

  if (.Platform$OS.type == "windows") {
    system2("Rscript", c("-e", shQuote(cmd)), wait = FALSE, stdout = FALSE, stderr = FALSE)
  } else {
    system2("Rscript", c("-e", shQuote(cmd)), wait = FALSE,
            stdout = "/dev/null", stderr = "/dev/null")
  }

  # Wait for startup
  for (i in 1:20) {
    Sys.sleep(0.25)
    conn <- tryCatch(
      socketConnection("localhost", port, open = "r+b", blocking = TRUE, timeout = 1),
      error = function(e) NULL
    )
    if (!is.null(conn)) {
      close(conn)
      return(TRUE)
    }
  }

  FALSE
}

# ============================================================================
# Display helpers
# ============================================================================

color <- list(
  reset = "\033[0m",
  bold = "\033[1m",
  dim = "\033[2m",
  red = "\033[31m",
  green = "\033[32m",
  yellow = "\033[33m",
  blue = "\033[34m",
  magenta = "\033[35m",
  cyan = "\033[36m",
  white = "\033[37m",
  # Bright variants
  bright_red = "\033[91m",
  bright_green = "\033[92m",
  bright_yellow = "\033[93m",
  bright_blue = "\033[94m",
  bright_magenta = "\033[95m",
  bright_cyan = "\033[96m"
)

print_banner <- function(session_id = NULL) {
  cat(sprintf("\n%s llamar%s", color$cyan, color$reset))
  if (!is.null(session_id)) {
    cat(sprintf(" %s[%s]%s", color$dim, session_id, color$reset))
  }
  cat("\n")
  cat(sprintf("%sType /help for commands, /quit to exit%s\n\n", color$dim, color$reset))
}

print_tool <- function(name, args) {
  # Function-style: tool_name("arg1", "arg2")
  if (length(args) > 0) {
    args_str <- paste(sapply(args, function(x) {
      if (is.character(x)) {
        s <- if (nchar(x) > 40) paste0(substr(x, 1, 37), "...") else x
        sprintf('"%s"', s)
      } else {
        as.character(x)
      }
    }), collapse = ", ")
    cat(sprintf("%s%s(%s)%s\n", color$dim, name, args_str, color$reset))
  } else {
    cat(sprintf("%s%s()%s\n", color$dim, name, color$reset))
  }
}

print_result <- function(text) {
  # Minimal output - just show line count, model will summarize
  lines <- strsplit(text, "\n")[[1]]
  n <- length(lines)
  if (n > 1) {
    cat(sprintf("%s(%d lines)%s\n", color$dim, n, color$reset))
  }
  # Single line results shown inline with tool call
}

render_markdown <- function(text) {
  # Bold: **text** or __text__ - bright white
  text <- gsub("\\*\\*([^*]+)\\*\\*", paste0(color$bold, color$white, "\\1", color$reset), text)
  text <- gsub("__([^_]+)__", paste0(color$bold, color$white, "\\1", color$reset), text)

  # Italic: *text* or _text_ (but not inside words)
  text <- gsub("(?<![\\w*])\\*([^*]+)\\*(?![\\w*])", paste0(color$dim, "\\1", color$reset), text, perl = TRUE)
  text <- gsub("(?<![\\w_])_([^_]+)_(?![\\w_])", paste0(color$dim, "\\1", color$reset), text, perl = TRUE)

  # Inline code: `code` - cyan
  text <- gsub("`([^`]+)`", paste0(color$bright_cyan, "\\1", color$reset), text)

  # Headers - colorful
  text <- gsub("(?m)^### (.+)$", paste0(color$bright_blue, "\\1", color$reset), text, perl = TRUE)
  text <- gsub("(?m)^## (.+)$", paste0(color$bold, color$bright_blue, "\\1", color$reset), text, perl = TRUE)
  text <- gsub("(?m)^# (.+)$", paste0(color$bold, color$bright_magenta, "\\1", color$reset), text, perl = TRUE)

  # Bullet points - green bullet
  text <- gsub("(?m)^(\\s*)[-*] ", paste0("\\1", color$green, "â€¢", color$reset, " "), text, perl = TRUE)

  # Links: [text](url) - blue text, dim url
  text <- gsub("\\[([^]]+)\\]\\(([^)]+)\\)", paste0(color$bright_blue, "\\1", color$reset, " ", color$dim, "(\\2)", color$reset), text)

  text
}

print_response <- function(text) {
  rendered <- render_markdown(text)
  cat(sprintf("\n%s%s\n", rendered, color$reset))
}

# ============================================================================
# Context tracking
# ============================================================================

# Model context limits (in tokens)
context_limits <- list(
  # Anthropic
  "claude-sonnet-4-20250514" = 200000L,
  "claude-opus-4-20250514" = 200000L,
  "claude-3-5-sonnet-20241022" = 200000L,
  "claude-3-opus-20240229" = 200000L,
  "claude-3-haiku-20240307" = 200000L,
  # OpenAI
  "gpt-4o" = 128000L,
  "gpt-4o-mini" = 128000L,
  "gpt-4-turbo" = 128000L,
  "gpt-4" = 8192L,
  "gpt-3.5-turbo" = 16385L,
  # Ollama (varies by model)
  "llama3.2" = 128000L,
  "llama3.1" = 128000L,
  "mistral" = 32000L,
  "mixtral" = 32000L,
  "qwen2.5" = 32000L
)

get_context_limit <- function(model) {
  # Try exact match first
  if (!is.null(context_limits[[model]])) {
    return(context_limits[[model]])
  }
  # Try prefix match
  for (name in names(context_limits)) {
    if (startsWith(model, name) || startsWith(name, model)) {
      return(context_limits[[name]])
    }
  }
  # Default
  128000L
}

format_tokens <- function(n) {
  if (n >= 1000000) {
    sprintf("%.1fM", n / 1000000)
  } else if (n >= 1000) {
    sprintf("%.1fK", n / 1000)
  } else {
    as.character(n)
  }
}

print_context_indicator <- function(used, limit, warn_pct = 75, crit_pct = 90) {
  pct <- (used / limit) * 100
  used_str <- format_tokens(used)
  limit_str <- format_tokens(limit)

  # Color based on usage (thresholds configurable)
  if (pct >= crit_pct) {
    col <- color$bright_red
    warn <- " (consider /clear)"
  } else if (pct >= warn_pct) {
    col <- color$yellow
    warn <- ""
  } else {
    col <- color$dim
    warn <- ""
  }

  cat(sprintf("%s[%s / %s tokens %.0f%%]%s%s\n",
              col, used_str, limit_str, pct, warn, color$reset))
}


# ============================================================================
# Main agent loop
# ============================================================================

run_agent <- function(opts) {
  cwd <- getwd()

  # Handle --list (exit early)
  if (isTRUE(opts$list)) {
    sessions <- llamaR:::session_list(cwd)
    cat(llamaR:::format_session_list(sessions), "\n")
    return(invisible(NULL))
  }

  # Load or create session
  session <- NULL

  if (!is.null(opts$session)) {
    # Resume specific session
    session <- llamaR:::session_load(opts$session, cwd)
    if (is.null(session)) {
      cat(sprintf("%sSession not found: %s%s\n", color$yellow, opts$session, color$reset))
      return(invisible(NULL))
    }
    # Use session's provider/model unless overridden
    if (is.null(opts$model)) opts$model <- session$model
    opts$provider <- session$provider %||% opts$provider
  } else if (opts$resume) {
    # Resume latest session
    session <- llamaR:::session_latest(cwd)
    if (is.null(session)) {
      cat(sprintf("%sNo sessions found. Starting new session.%s\n", color$dim, color$reset))
    } else {
      # Use session's provider/model unless overridden
      if (is.null(opts$model)) opts$model <- session$model
      opts$provider <- session$provider %||% opts$provider
    }
  }

  # Create new session if needed
  if (is.null(session)) {
    session <- llamaR:::session_new(opts$provider, opts$model, cwd)
  }

  print_banner(session$id)

  # Start/connect to MCP server
  cat(sprintf("%sStarting MCP server on port %d...%s\n", color$dim, opts$port, color$reset))

  if (!start_server(opts$port, opts$tools)) {
    cat(sprintf("%sError: Could not start MCP server%s\n", color$bright_magenta, color$reset))
    cat("Make sure llamaR package is installed.\n")
    return(invisible(NULL))
  }

  # Connect
  conn <- tryCatch(
    mcp_connect(port = opts$port, name = "llamar"),
    error = function(e) {
      cat(sprintf("%sError connecting to server: %s%s\n", color$bright_magenta, e$message, color$reset))
      NULL
    }
  )

  if (is.null(conn)) return(invisible(NULL))

  cat(sprintf("%sConnected. %d tools available.%s\n\n",
              color$dim, length(conn$tools), color$reset))

  # Load context files
  context_files <- llamaR:::list_context_files(cwd)
  system_prompt <- llamaR:::load_context(cwd)

  if (length(context_files) > 0) {
    cat(sprintf("%sLoaded context:%s\n", color$dim, color$reset))
    for (f in context_files) {
      cat(sprintf("  %s%s%s\n", color$cyan, basename(f), color$reset))
    }
    cat("\n")
  }

  # Get tools for LLM
  tools <- mcp_tools_for_api(conn)

  # Tool handler
  tool_handler <- function(name, args) {
    print_tool(name, args)
    result <- tryCatch({
      mcp_call(conn, name, args)
    }, error = function(e) {
      cat(sprintf("%sTool error: %s%s\n", color$bright_magenta, e$message, color$reset))
      list(text = paste("Error:", e$message))
    })
    text <- result$text %||% ""
    if (nchar(text) > 0) {
      print_result(text)
    }
    text
  }

  # Conversation state - restore from session
  provider <- opts$provider
  model <- opts$model

  # Display model
  display_model <- model %||% switch(provider,
    anthropic = "claude-sonnet-4-20250514",
    openai = "gpt-4o",
    ollama = "llama3.2"
  )

  cat(sprintf("%s%s @ %s%s\n", color$dim, display_model, provider, color$reset))

  # Track token usage for context indicator
  session_tokens <- session$tokens %||% 0L
  context_limit <- get_context_limit(display_model)

  # Show resumed message count
  if (length(session$messages) > 0) {
    cat(sprintf("%sResumed session with %d messages.%s\n",
                color$dim, length(session$messages), color$reset))
    if (session_tokens > 0) {
      print_context_indicator(session_tokens, context_limit,
                              opts$context_warn_pct, opts$context_crit_pct)
    }
  }

  # REPL
  while (TRUE) {
    # Read input via bash read
    prompt <- system(
      sprintf('read -p "%s>%s " line && echo "$line"', color$green, color$reset),
      intern = TRUE
    )

    # Handle EOF (Ctrl+D)
    if (length(prompt) == 0) {
      cat("\n")
      break
    }

    prompt <- trimws(prompt)
    if (nchar(prompt) == 0) next

    # Handle commands
    if (startsWith(prompt, "/")) {
      cmd_parts <- strsplit(prompt, "\\s+")[[1]]
      cmd <- tolower(cmd_parts[1])
      cmd_arg <- if (length(cmd_parts) > 1) cmd_parts[2] else NULL

      if (cmd %in% c("/quit", "/exit", "/q")) {
        break
      } else if (cmd == "/tools") {
        cat(sprintf("\n%sAvailable tools:%s\n", color$bold, color$reset))
        for (tool in conn$tools) {
          cat(sprintf("  %s%s%s - %s\n", color$cyan, tool$name, color$reset,
                      tool$description %||% ""))
        }
        cat("\n")
        next
      } else if (cmd == "/clear") {
        session$messages <- list()
        session$tokens <- 0L
        session_tokens <- 0L
        llamaR:::session_save(session)
        cat(sprintf("%sConversation cleared.%s\n", color$dim, color$reset))
        next
      } else if (cmd == "/sessions") {
        sessions <- llamaR:::session_list(cwd)
        cat(llamaR:::format_session_list(sessions), "\n")
        next
      } else if (cmd == "/model" && !is.null(cmd_arg)) {
        model <- cmd_arg
        session$model <- model
        llamaR:::session_save(session)
        cat(sprintf("%sModel set to: %s%s\n", color$dim, model, color$reset))
        next
      } else if (cmd == "/provider" && !is.null(cmd_arg)) {
        provider <- cmd_arg
        session$provider <- provider
        llamaR:::session_save(session)
        cat(sprintf("%sProvider set to: %s%s\n", color$dim, provider, color$reset))
        next
      } else if (cmd == "/context") {
        if (length(context_files) == 0) {
          cat(sprintf("%sNo context files loaded.%s\n", color$dim, color$reset))
          cat("Create LLAMAR.md or fyi.md in this directory to add context.\n")
        } else {
          cat(sprintf("%sLoaded context files:%s\n", color$bold, color$reset))
          for (f in context_files) {
            cat(sprintf("  %s%s%s\n", color$cyan, f, color$reset))
          }
        }
        next
      } else if (cmd == "/help") {
        cat("
Commands:
  /quit, /exit   Exit llamar
  /tools         List available tools
  /clear         Clear conversation (keeps session)
  /sessions      List sessions for this directory
  /context       Show loaded context files
  /model <name>  Switch model
  /provider <p>  Switch provider (anthropic, openai, ollama)
  /help          Show this help

")
        next
      } else {
        cat(sprintf("%sUnknown command: %s%s\n", color$yellow, cmd, color$reset))
        next
      }
    }

    # Add user message to session
    session <- llamaR:::session_add_message(session, "user", prompt)
    llamaR:::session_save(session)

    # Send to LLM with tools
    # Check API key (not needed for Ollama)
    if (provider != "ollama") {
      .config <- llm.api:::.get_provider_config(provider)
      api_key <- .config$api_key %||% ""
      if (nchar(api_key) == 0) {
        cat(sprintf("%sWarning: No API key found for %s%s\n", color$yellow, provider, color$reset))
        env_var <- switch(provider,
          anthropic = "ANTHROPIC_API_KEY",
          openai = "OPENAI_API_KEY",
          paste0(toupper(provider), "_API_KEY")
        )
        cat(sprintf("Set %s in ~/.Renviron\n", env_var))
        next
      }
    }

    result <- tryCatch({
      agent(
        prompt = prompt,
        tools = tools,
        tool_handler = tool_handler,
        system = system_prompt,
        model = model,
        provider = provider,
        verbose = FALSE  # We handle display ourselves
      )
    }, error = function(e) {
      cat(sprintf("%sError: %s%s\n", color$bright_magenta, e$message, color$reset))
      NULL
    })

    if (!is.null(result)) {
      print_response(result$content)

      # Update token count and show context indicator
      if (!is.null(result$usage)) {
        session_tokens <- session_tokens + result$usage$total_tokens
        session$tokens <- session_tokens
        print_context_indicator(session_tokens, context_limit,
                                opts$context_warn_pct, opts$context_crit_pct)
      }

      # Add assistant response to session
      session <- llamaR:::session_add_message(session, "assistant", result$content)
      llamaR:::session_save(session)
    }
  }

  # Final save
  llamaR:::session_save(session)

  # Cleanup
  cat(sprintf("\n%sGoodbye.%s\n", color$dim, color$reset))
  suppressWarnings(mcp_close(conn))
}

# ============================================================================
# Entry point
# ============================================================================

if (!interactive()) {
  opts <- parse_args()
  run_agent(opts)
}
